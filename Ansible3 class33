FORKS, HOST KEY GEN, PASSWORDLESSLY, APT/YUM MODULE, ROOT PRIVILEDGES, IDEM POTENCY, ABSENT, USER MODULE, ENCRYPTION , SUDO !!, SETUP MODULE 

********* WE HV 2 DEFAULT MODULES : Command module and setup module

httpd is a package manager for yum (redhat) while apache or debiem is a package manager for apt (ubuntu)

****** 1:35:30   its actually a better way to install openssl on your local env bc once u destroy your instance, it means ull hv to always be reintalling it but if you hv it
on your local env and you want to encrypt anything youcan just open openssl, u can use it to encrypt anything and you can send a PW or a key to someone then if they hv openssl 
they can decrypt it, they can use decrypt and get whatever info your trying to send 

*********** 1:37:22 you used sudo !! , was that to recall the previous command , in all cases
yes i want to recall the last command but am adding sudo to it, these are linux command which u guy shud hv done when u did linux, when u look at the short cuts in linux

58:16   *******we created the user in the control node but we had to ssh into the remote node(home of ansible to see the encryted PW of the user we created in /etc/shadow  ?


what command do you use to find your present working dir?  
ANS : pwd
now if i ask you to find your pwd, i dnt expect you to write a script, to put that insid eof a script bc its a one line command, its a command that u can directly execute on ur CLI
BUT if you have a multiple/series of commands that you want to execute then you can put them in a script 
so thats what an adhoc command is and we do that bc its smt that we dnt execute often 
adhoc command is a one line command and its smt we dnt execute often but if we hv multiplr command that we always run all the time then 
it is best practice to put multiple commands in a sript and  its less prone to error and all the time you run the script, you are runing the same command so its less prone to
error if you execute it as a script as oppose to u typing 10 commands bk to bk on the cli, you are prone to make mistakes
so for one line you can run it directly on the cli but for multiple commands u put it in a script thats waht automation is about 


so for ansible we hv adhoc commands but if we hv multiple commands that we want to pass tru ansible then we can write a play bk 

anytime we want to create a file , we use the file module
referring to video3 class33 ************ 1:05


***********13:06         ................ STARTS

i hv my config files so ill 
trfrm init
tefrm validtae
terfrm apply
its now creating my instance   ( he probably destroyed evrything at the end of last class
just as we did the other time am goin to b able to ssh in to my insatnce which is my control node 
after sshing , i need to connect with ssh but i wnat to do it passwd less authentication so ill exchange a key
so this is the processwe already went tru and u shud be familiar with it now
you first provison ur instances and once evrytin has been installed , then we go ahead and create our ssh keys

output:
control server
ansible_publicip = 54.185.247.171
  instance private ip =[
"172.31.21.91"
"172.31.28.218"

 ********************** the host
inatance pub ip 
35.91.190.201
35.89.8.147

rhel private ip
172.31.21.92
public
50.112.62.228

18:30******* evryting has been created so we go into our host file 

so we first ssh into our that instance  (using the public ip): 54.185.247.171
after which we configure our host file
in aws click conncet, he copied the ssh command for the instance  54.185.247.171

19:23******* 
again am doing this still on my terminal (terfrm IDE) but hv already provisIoned dit in my vscode 
so i can stilluse my vscode to do it, and ill show you when we write playbks 

#### 1) 
but for now ill just ssh in 
splits his terminal
cd into downloads , where the key is , so that it finds the key
paste the command 
yes
now am in my instance 
so i caraeted a user called ansible
so ill 

####  2)
ubuntu@ip-172-31-28-203: $ sudo su - ansible 

now am in my ansible server
ansible@ip-172-31-28-203: $ ansible aa -m ping   ... .. said  he meant to type all but its seeing it that he wants to ping the group
provided host list is empty, only localhost is available 
ansible@ip-172-31-28-203: $ ansible localhost -m ping 
success
now i can cd and config my host file 

##### 3)
ansible@ip-172-31-28-203: $ vi /etc/ansible/host
and we see evrythin has been commanted 
so i need to now insert my host
i want to create 2grps just as we did it the other time    .......... 23:45
the grp could have 20 server, 50 servers
created db and web grp

so basically hes doing the same thing WE Already did in video2

#### 4)

to disable key host checking (we need to change to false)
ansible@ip-172-31-28-203: $  vi /etc/ansible.cfg
as we see evrytin is commented out , it is bc evrytin is ruuning by default , they are default setting, default just means ansible config is in the etc/ansible  bt if u want 
to see the actual file run this command and it will generate for you your actual file ansible-config init --disabled -t all > ansible.cfg
ansible@ip-172-31-28-203: $  ansible-conifg init --disabled -t all > ansible.cfg
am using this to redirect, its going to overide evrything in the config file so the config file wil now hv content

ansible@ip-172-31-28-203: $  vi /etc/ansible/ansible.cfg                       *but he didnt see the file so he ls
ansible@ip-172-31-28-203: $  ls
ansible.cfg                                          ****** ok it created it in my pwd 
ansible@ip-172-31-28-203: $  cat ansible.cfg
we see the configfile and most of the tins hv been commented

 
31:35 ****************************  FORKS 
we hv what is called forks
its like how many servers ansible can confiure ta once ie in parrarrel


INTERVIEW QUSETION
can you configur your ansible so that it execute task on remote host in series , ie one hsot after another

ANS:
yes you can do that by setting your forks number to 1 so that ist only executing task on one SERVER AT A TIME 

bt right now by default its set to 5, so its able to configure 5servers at the same time, basically in parrarrel 

#************* by deafault keyhost checking has been set to true but now we hv to change it to false
so vi 
ansible@ip-172-31-28-203: $  vi ansible.cfg
and cahnge true to false

SO HOST KEY CHANGEHAS BEEN configured , so we wont be asked if i want to connect 

##### 5)
next
ansible@ip-172-31-28-203: $  ssh-keygen
key generated

ansible@ip-172-31-28-203: $ ssh-copy-id 172.31.21.91
password :ansible 
key added
ansible@ip-172-31-28-203: $  ssh-copy 172.31.28.28.218
key added
ansible@ip-172-31-28-203: $ ssh-copy 172.21.92

so hv configured my remote hoste to be managed remotelessly
key 


38:21                  contd frm video2
**************** back to ansible modules

6) (Apt)  yum Module

Used to install a package in the ansible client.
$ ansible db -m apt -a "name=apache2 state=present" --become

$ ansible db -m service -a "name=apache2 state=started" --become

$ ansible db -m apt -a "name=nginx state=present" -b


                                              ROOT PRIVILEDGES   "-b"
41:05 ***** 

we need root priviledge to install a package  and  apt or yum will be used interchangeably  e.g yum for redhat and apt for ubuntu (debiem package manager) 
so we use a command called "become" to excalate our priviledges or a " -b " option , -b just means you wnat escalate the priviledges, w ewnt to use sudo prividege

ansible@ip-172-31-28-203: $ $ ansible all -m yum -a "name=apache2 state=present" --b
failled for the first ubuntu server
failed for the 2nd ubuntu server
also failed for the redhat server     *********** bc it couldnt find apache tool

*********  yes when we are working with yum module, apache tool is nt part of the yum repo, instead you need to install httpd 
httpd is the same package but its the package thats in the yum repository  bc were trying to install a package(apache) thats not part of yum repository
so bc of this now we hv to change our package 
but if i still want to install apache then apache is a package for the apt repository or dibiam 
$ ansible db -m apt -a "name=apache2 state=present" --become
   this package is apcahe
but if am using yum i need to insatll httpd
$ ansible db -m yum -a "name=httpd state=present" --become
   thats the package for yum 

  ansible@ip-172-31-28-203: $ $ ansible all -m apt -a "name=apache2 state=present" -b
chnage is true
  succes for the first ubuntu server
change is true
success for the 2nd ubuntu server
But  failed for the redhat server  

####### 6iI)                                   
45:29
*************  *****************             IDEM POTENCY

if i run the caommand again  :
  ansible@ip-172-31-28-203: $ $ ansible all -m apt -a "name=apache2 state=present" -b

chnage is false                              *********** this is because the package has already been installed & so, ansible will nt install it again
  succes for the first ubuntu server
change is false                                         ********* this is called idem potency
success for the 2nd ubuntu server
But  failed for the redhat server  

   INTERVIEW QUESTION
WHAT is idem potency 

ANS:
Anisble does not reinstall  a package thats already insatlled or run a task that has already been completed 


###  6iII)
***************************** ABSENT 
 to remove the package ill say state is absent 

  ansible@ip-172-31-28-203: $ $ ansible all -m aptm -a "name=apache2 state=absent" -b

chnage is true                            ***********   pacakge has been removed 
  succes for the first ubuntu server
change is true                                       
success for the 2nd ubuntu server
But  failed for the redhat server  


*********** so now we see we can use yum or apt to install our packages


#### 6iV)
48:07 ************
                                    USING YUM 
to use yum , instead of all , ii use the grp name : web       ( we can use either present or latest)

  ansible@ip-172-31-28-203: $ $ ansible web -m yum -a "name=httpd state=present" -b      **** so it will instal httpd on yum on that particular grp &it wilinstall the lastest
it will check my web grp whic is redhat                                                      nd am using -b bc we are installing a package, we nid sudo priviledges

change =true                                                                                         

******** we installed using a yum module

********* so we hv apache(or he said package) module, apt module, yum module 
all these are ansible modules that you can use , modules are small programm that we are using 
all thses are package managers
we are using package mangers to be able to install package in our servers

48:42
***********
we can use a service module if we need to start our appl
we can install ngnix and we can start it by using a service module

#### 
   7) Service Module

You can use the service module to manage services running on the remote nodes managed by Ansible. This will require extended system privileges, so make sure your remote user has sudo permissions and you include the --become option to use Ansibleâ€™s privilege escalation system. Using -K will prompt you to provide the sudo password for the connecting user.

$ ansible all -i inventory -m service -a "name=nginx state=restarted" --become -K

$ ansible all -m service -a "name=nginx state=stopped" --become -K

*********** lets install ngnix on our db group
installing ngnix using apt

  ansible@ip-172-31-28-203: $ $ ansible db -m apt -a "name=nginx state=present" -b
change = true          installed

now to start the service                 ************* we need sudo priviledge to start it  so "-b"  , its only admin who can start it
  ansible@ip-172-31-28-203: $ $ ansible db -m service -a "name=ngnix state=restarted" -b
change=true
state = started

53:20
on the other splited part of the terminal
terraform output
we see our output
he copied one of the public ip of the host and bc ngnix runs on port 80
35.91.190.201:80    in google
we see apache runing on that particualr ubuntu
so we hv used service module to start the service 
we can still use the service module to stop it 
  ********  
  ansible@ip-172-31-28-203: $ $ ansible db -m apt -a "name=nginx state=stopped" -b
now the service has been stopped

56:18

############ 8)

8) User Module
Used to create user accounts.  (TO create users, but you wil first craete an encrypted pW for the user)
Create a password encryption
Generate the password from your local environment
$ openssl passwd -crypt <desired_password>

$ ansible db -m user -a "name=Peter password=wiyiMQbLhCRUY shell=/bin/bash" -b

                                ENCRYPTION , SUDO !!
eg 
 ansible@ip-172-31-28-203: $ cat /etc/shadow
permission denied 
 ansible@ip-172-31-28-203: $ sudo !!
we see the list  of paswords
we see ansible pW was encrpted, so pW are stored as encrypted in /etc/shadow file

eg                         CREATING A uSER

 ansible@ip-172-31-28-203: $ openssl passwd -crypt mark
unknown                                                           ********** he said openssl isnt installed


************ he went to the other part of his terminal
(base) - terraform files openssl passwd -crypt mark                       ********* bc he has openssl insatlled here his local env, the other part is his ec2 instance
psv/alszgssq                                                       ***********i hv encrypted the PW n it has been genearated,this is the PW we need to pass as encrypted

*********** back on the other part of the terminal 
using the user module , i will craete the user in the db grp
 ansible@ip-172-31-28-203: $   ansible db -m user -a "name=mark" password=psv/alszgssq shell=/bin/bash" -b
change=true                         ********   it has created a user mark
home : "/home/mark"                        created a home 
 password :                            NOT LOGGING PASSWORD            ******* so u cant use d encryted PW a sa login PW, what u nid to use is d decrypted PW(mark)
its saved in the/ etc/paswd thats why its encrypted

1:03:19
to see the encrypted PW , we need to ssh into one of the instances (so we left the control node)
psv/alszgssq   
ansible@ip-172-31-28-203: $  ssh 172.31.21.91
welcme to ubnuntu                                       ******* now in the home of ansible 
ansible@ip-172.32.21.91 :$ cat /etc/passwd
mark : /home/bin/bash
ansible@ip-172.32.21.91 :$  cat etc shadow 
permission denied
ansible@ip-172.32.21.91 :$  sudo !!
mark: psv/alszgssq                         encrypted but to login as mark , ill pass the PW as mark cos mark is the PW that we encrypted,
                                                 but when using an ansible playbk to craete a user u hv to encrypt d PW using openssl and then pass it 



####                           
9)   Setup module
This is a default module and is used to gather facts about the hosts.  egused to go to the host to gather facts, to find out wheter python has been installed, to find out
what package manager this server uses..... this is also a default module

The setup module returns detailed information about the remote systems managed by Ansible, also known as system facts.

To obtain the system facts for group1, run:

$ ansible group1 -m setup

This will print a large amount of JSON data containing details about the remote server environment.

To print only the most relevant information, include the "gather_subset=min" argument as follows:

$ ansible group1 -m setup -a "gather_subset=min"

To print only specific items of the JSON, you can use the filter argument. This will accept a wildcard pattern used to match strings. For example, to obtain information about both the ipv4 and ipv6 network interfaces, you can use ipv as filter:

$ ansible group1 -m setup -a "filter=ipv"


#########a)

ansible@ip-172.32.21.91 :$  exit                    the ****** host instance/ansible home to go bk to the contorl node
ansible@ip-172.31.28.203 :$ ansible web -m setup                    ****** it will return info abt this redhat server
success
there are lots of info it returns , its called gathering fact

1:7:50
*********eg 
ansible architecture" x86_64
some of the facts returned are like variables that can be accessesed and we wil see hw to do that
if i wanted to,i can use a variable to find the architecture of my server, i can use it as a filter
therfor i can use my setup module and call these variables
ill say if ansible architecture"  is  x86_64 , i can pass condition like that 
then ansible will go out bc of the setup module, it will look for servers or host that has this architecture and those are the servers that its going to perform  a task on  

also i can look at 
ansible _distribution : redhat                   ******** and we will be using this variables
i can say that i want to configure instances whose ansible distribution is redhat
eg 
when i was running the command that we were installing httpd or apache, i would hv passed a variable and say install apache if ansible distribution is debiem bt install 
httpd if ansible distribution is erdhat 
so the satup module will go out and check all your servers then whatevr dustribution it returns if the distribution is redhat its goin to install httpd , if the distribution
is debiam it will install apache 
so thats hw u can use ansible with a setup module to automate process to dynamically hv it go an install packages based on the operating system, we wil see hw we can do that

*******there are lot of varaiables, key value pairs that you can reference based on what you want
you 

ansible os family, ansible pkg_mg , so you can use all these as variables to filter out what resource sor server you want to maintain or configure 


#########  b)
1:10:41              ***************


To print only the most relevant information, include the "gather_subset=min" argument as follows:

$ ansible group1 -m setup -a "gather_subset=min"


eg
ansible@ip-172.31.28.203: $ ansible web -m setup -a "gather_subset=min"
 so it wont print out evrytin , just the most inportant, like a summary of all the vraiables you  can use reference


******** we can disable this setup madule by passing  a flag called gather facts = false 
we will see hw to do that in playbks 


          INTERVIEW QUESTION
whan you  pass an option like :gather facts= to false what module are you disabling

ANS: 
You are diasbling the setup module



10)
###### Debug module
Executes only on the local host to display some information- message or variable value.

We do not need ssh connectivity or password for a debug module. When using the debug module, the arguments will either be
- msg = to display a message
- var = to display a variable

**Default variables**                             ******** these are some variables within ansible 
    - inventory_hostname
    - inventory_hostname_short
    - groups/ groups.keys()
$ ansible all -m debug -a "var='This is a debug module'"             ******** it wil perform d task on my ansible control node display the msg on my ansible control node 
$ ansible all -m debug -a "msg={{}}"                                 *** so am using a debug module for info so that i can get the info y bc if am printing smt like  a file
                                                                  or perfroming a task, its been performed on the remote host, bt if i want info i can use debug so that it
                                                              prints out info on my ansible control node and with that i can pass d arguments as either variable e.g 
inventory_hostname

You can use debug to display variables.
$ ansible all -m debug -a "var='inventory_hostname'"         ******* d eg, in quotation marks like this bc already this is a variable
$ ansible all -m debug -a "msg={{inventory_hostname}}"      **** bt i can pass d same tin using a msg argument bt it has to be in these brackets,bc its how we read variables

If you have an inventory with entries like 'server1.cloud.production.host' then the command below will return server1.
$ ansible all -m debug -a "msg={{inventory_hostname_short}}"

You can also use debug module to display groups or groups keys in your inventory.
$ ansible all -m debug -a "var='groups'"
$ ansible all -m debug -a "var='groups.keys()'"


###### a)
*********   1:15:26
eg
 inventory hostname of  db host group

ansible@ip-172.31.28.203: $   $ ansible db -m debug -a "var='inventory_hostname'"                  ***** am specifying this is a variable
success
ineventory hostname : 172.31.21.91                 ******* on my db the iventory hostname are theese two 
success
ineventory hostname : 172.31.28.218               ***** bc its a debug module ,it will return this info

but if i want info for ansible os family
ansible@ip-172.31.28.203: $  ansible db -m debug -a "var='ansible_os_family'"      *****  i want to find out for my db what are my os ansible fmaily 
success
varIble is nt defined 
 success
varIble is nt defined

ansible@ip-172.31.28.203: $    ansible db -m debug -a "var='ansible_distribution'"   
success
variable not defined
ansible@ip-172.31.28.203: $    ansible db -m debug -a "gather_subnet=min'"              ******* 1:18:13
we see a lot of variables like when we ran setup module

******* dnt knw why its saying vaiable not defined , well thats how u use  a variable  but if you are pasing it as a msg put it in bracket/calibras

ansible@ip-172.31.28.203: $   ansible db -m debug -a "msg={{inventory_hostname}}"      
success
msg: 172.31.21.91
succes 
msg:    172.31.28.203             ***** we see the key word msg ,the key is msg

*** so all these varaiables are been read using our debug module and its displaying info on our system, inventory hostanme is been displayed as a msg

so thats how we use debug module
as we go further we ll see hw we can this debug


### b)
********** 

TO KNOW THE GROUPS I HAVE 

$ ansible all -m debug -a "var='groups'"


###  c)
********* 
  to know the keys i have 
i can pass it as a msg or a variable 


ansible@ip-172.31.28.203: $ ansible db -m debug -a "msg='groups.keys()'"
  172.31.21.91 success
  msg: 
   all
ungrouped
   db
  web                                     **** so these are the grps that i hv in my invenory

172.31.28.218 success
  msg: 
   all
ungrouped
   db
  web     
                              so am using a degug to read my inventory and the variables that are defined inside of my inventory and these variables are been retuned as grp


********* these are some of the basic modules that w eneed to knw , bt again as we lookde, ANSIBLE has a ton of modules that are there, public modules taht are there that
you can use 



###### complaint
am trying to run the openssl its nt working, i copied the command diresctly frm the scripte

ANS
OK dnt copy, type it bc atimes the operator may see it as smt different

i typed it the same thing
ok , tyr it on your gitbash, bc the most imp thing iS that you just want to encrypt the PW 


   QUESTION
1) when u did the ssg ken gen, you configured for 3servers, what if you want to do it for 50 servers , is that what you will do for all 50?
also when you created a user you first created a PW, but to do it for 50 users, is ther a way to do it in bulk

ANS:
you can hv a script that can loop tru your invnetory , bt ryt now we v been do in it maunally bc we nid to understand the concept, bt as we go further Tomao we wil look at 
dynamic inventories if i hv 50servers ders no way ill go into the 50 serevers to get the inventories, the i[p addresses  so i can configure it, with dynamic invnetory, i 
dnt need to configure my host file, instaed ill use a script taht wil go into aws , even if its 100servers, based on the script am using it goes and and get all the servers
ips and return it as an inventories then ansible will just use that as an inventory to go and do your configuration

but what ull do here, esp in your prod env goin forward, most companies wil use what is called custom AMIs, ie an AMI that hv created bc am using it for a coy, this AMI will
be managed by ansible b4 i craete the AMAI, i already exchange the key i pass in the key, the ssh key, you load it with all the software b4 you craete an instance for it
so when i introduce ansible to mg8 it i dnt nid to worry abt ssh keys anymore bc this custome AMI alraedy has a user called ansible baked in, a pecific key has already been 
exchanged so my ansible usser is already set so ill create ec2 instances based on this AMi, i can spin up a 100 instances based on this AMi.when i use that AMI , it will 
already hv been configured to be maintained by ansible but if i just hv insatnces that exists in aws then we ll see hw i can use dynamic inventory script that wil go into aws 
search tru d region, get all d inastnces and return that as an inventory then ansible wil use the ip addreses and go out and just do configuration.

*** 1:43:20
then for users, u can use loops , loop tru instances, if i hv maultiple packages that i need to install, i can use like foreloops that will loop tru all the variables that i 
hv, it will loop tru all the packages and one by one & those wil be installed & the same thing again for users,we can set a foreloop so that it  loops tru all our inventories
and for each server its configuring a user

as we go tru play bks and roles then things will start to mk more sense bt now we are focusing on the conept and the basics of hw actually things works



prof diff btw task and ..





 






















