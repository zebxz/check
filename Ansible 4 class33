PLAYBOOK, IMPORT TASK, INCLUDE TASK, FUNDAMENTAL DIFF BTW  import task and INCLUDE TASK, PASSING A VARIABLES, USING IMPORT WHILE PASSING A VARIABLE, USING INCLUDE WHILE
PASSING A VARIABLE/DYNAMICALLY, ANSIBLE ROLES, ROLE DIRECTORY STRUCTUR, CREATNG A ROLE FOR A PLAYBOOK /CONVERTING THE PLAYBOOK (httpd) TO A ROLE, CONFIGURING THE ROLE, MY 
NEW ROLE BK, CREATING A USER ROLE, SUMMARY OF HOW TO CREATE ROLES., 3 WAYS TO USE ROLES  
 
31:14
dabiem and Redhat are both ansible os family 

29.08
setup module is the default module so even if we dnt indicate gather facts = true ,its still goin to run 
except i want it to disable it  then i have to indicate it as false   

1:16.00
these are template files, all templates file  we use what is called ginger templating 

1:20:00
wnat to trasnfer a file frm my host to my remote server, it is a static file, ie it doesnt hv any variable so it wont change

1:27:40
an ansible os family  is an inbuilt varaiable 
also ansible processor core is an inbuilt variable

1:32:15
bc the variable is substituted at run time  therfore, it makes it dynamic, ie when its running thats when the name will be substituted
so bc its dynamic when u use import,it will fail bc import only uses static 
so if i created a file with calibrases like this {{ansible_os_family}}., this is static meaning this name is not changing then i can use import bc import it will just tk
the file and transfer it as it is

###  RECAP

the syntax of playbook: playbks are written in yaml language and all files should hv yml
yaml format is very strict with identation


       A PLAYBOOK
if you have tasks that is repetitive/things that you often do, then ansible gives you a way that you can write script format in ansible ie a playbook
A playbk will contain a number of plays 
the basic thing a play will have, it will have a host, like what is your target, so evry play needs to have a target, it needs to have the remote host that you want to 
configure, so it will have a host.
but also on the bare minimum it will have atleast one task, a task will have a module bc modules are small programes ansible use to do configuration
if you have a task for ansible to do, you need to give it a module , like what program is it goiin to use 
if the task is to install a package then you need to give it a module that installs packages
if its to copy or transfer a file you can use a file module
if its to copy data that are changes/dynamic its a file that has variables and these variables will be read at runtime then we dnt use a copy module rather ansible rEQs you to
use a template
A template is just a mode whereby things can be put in so when u use a template module its a module that will copy dynamic data


8:30 
********************* START

1)
####  
14:36   TO INstall multiple packages      
    install_multiple_pkgs.yaml

18:48 
it is skipping bc of the conditons 
its using the setup module to read the variables then it skips a server when the conditions are not met
insatll webserserver on redhat 
install java on redhat
install webserver on debian family
install java on redhat
so we hv 4task that have been carried out
but instead of me running it like this i can break down this playbk, bc am still using conditions, i can reduce the lines on my playbk when i can create reuseable task


                               USING A PLAYBOOK WITH IMPORT & INCLUDE TO INSTALL MULTIPLE PACKAGES
#####2)
24:45               install_multiple_pkgs_with _import_and_include.yaml

***** 
so for each of the 4 task executed in the playbk above, i can create a task for each of them and on my playbk ill  use what is called include_tasks to import these tasks  
so now each of these tasks are reuseable bc they are not tied to a particular playbk
so i can call these task in any other playbk by saying include_tasks and i just refernec the name , so am making my task to be reuseable

29:08 
********** 
setup module is the default module so even if we dnt indicate gather facts = true ,its still goin to run 
except i want it to disable it  then i have to indicate it as false 


  ##2i)
      
       FUNDAMENTAL DIFF BTW  import task and INCLUDE TASK 
1)When we use import task it just says
chANGed : 172.31.24.167
but when we say include task its giving us a range of information, the name of the task that is included
*********    included: /home/ansible/ansible-mc-series/05-playbooks/05-using and include/install_ java_Redhat.yml
so include is giving us more task
again we wil see more diff btw include and import
u ll use include when you want to include tasks that have variables ie task that change
2)so we use import when we are using it on static data ie does not change ie we cant use import while passing a variable, video3, we use copy module when copying static file 
3) 38.31... include task is used for dynamic data, ie we can use include task while passing a variable 
       video 3... so we use template module when you are copying the dynamic files

31.14
***************
install webserver on debiem.yml and install webserserver on redhat, 
dabiem and Redhat are both ansible os family 
so i can pass a variable within this name 
when i pass a vriable i can reduce this playbk (install_multiple_pkgs_with _import_and_include_.yaml )even further
i reduce it furtehr by been able to use thses as varibales so it pulls the right file



#### 3)      32.25      USING IMPORT WHILE PASSING A VARIABLE  WILL FAIL/IMPORT IS USED FOR DATA THAT DOES NOT CHANGE
34.25
ran the script  but failed
error
 when using import you cannot use variables ,you cannot hv data that is changing bc this variable {{ansible_os_family}}is suppose to be substituted when the playbk is running
so we use import when we are using it on static data ie does not change

32:25
***************
so because am passing a variable, i can rewrite this playbk
 frm NO.2(install_multiple_pkgs_with_import_and_include.yaml) to 3A)(install_import.yaml) or 3B)(install_multiple_pkgs_with_include.yaml)

                     (install_import.yaml)
---
  - name: Simple play to install multiple pkgs
    hosts: all                                     ******am saying i wnat to import task 
    gather_facts: true
    become: yes
    tasks:                                                                    ******** if the os family is debiaem then it wil import debiem.yml 
      - import_tasks: install_webserver_{{ansible_os_family}}.yml    *** when it does the setup,its goin to import a task, if the os family is Redhat,it wil import redhat.yml
      - import_tasks: install_java_{{ansible_os_family}}.yml

so now am reducing my playbk frm  (No.2) to (NO.3), ie reducing it to just 2lines bc am now passing/using a variable

#######################################################################################################################################


             HOW TO GET PREDEFINED & INBUILT VARIABLES USING SETUP MODULE
(1:27:29, further xplanation for kelvins question) if u pass smt inside the calibres, its a variable 
so we hv some predefined variables or inbuilt variables 
an ansible os family is an inbuilt varaiable
but hw do we knw
ansible web -m setup                                    ****** am running my setup module 

once i run this , it will go to my server/host and it wil return info abt the server, which icludes predefined variables that i can access
 ansible_processor_cores        **** i can access this info bc its a filter
to access this i can pass it as a variable  - import_tasks: install_webserver_{{ ansible_processor_cores}}.yml
so as i gather my facts, once it gets to my host, ist goin to stumble upon an ansible processor cores,  once it sees that, it ll return it here {{ ansible_processor_cores}} it
exchanges the value bc these are inbuilt variables, variables that hv alraeady been predefined inside ansible
thats why you need to knw what variable you are looking for 
e.g 
when i go tru this file, to the part of the ansible os family, it says RedHat, 
so when i was writing my code, i specifically wrote one of the file to be RedHat:install_webserver_RedHat.yml ,exact name as defined in d setup file:bc i want to substitute 
this name ansible os family, i want ansible to find this name, os family , is goin to find it as REdhat, then it will substitute it with the exact name 


                        DEFINED VARIABLES MISSPELT ISSUE
but if i had changed the name , even just by misspeling it e.g instead of RedHat, i said Redhat, it wil fail bc it wont find it 
so am using my setup to look tru the instance, the remote host, so when it reads all the variables, it sees that there is an os family,  then bc in my defination am using a 
variable, its goin to substitute the variable {{ansible_os_family}}., with the right info in the setup
and we defined that if you use import, the variable will only be subsitute when the ansible playbk is running bc ansible has to go and get the fact first b4 it is able to 
read the variable, now bc the variable is substituted at run time  therfore, it makes it dynamic, ie when its running thats when the name will be substituted
so bc its dynamic when u use import,it will fail bc import only uses static 
SO if i created a file with calibrases like this {{ansible_os_family}}., this is static he meant if we had created a file named ansible os family then we can put it inside
the calibrases meaning this name is not changing then i can use import, bc import, it will just tk the file and transfer it as it is
but if i want to do it dynaically then ill use include_task, bc include is what substitutes values dynamically

1:54:08
QUESTION

is there a command to pass so that capital for the RedHat stays correct
ANS:
we hv what is called build in or already predefined variables that you cant change bc these are already values that come with your system
so if its RedHat that show the variable has already been defined, so we cant alter it to make it case insensitive
i dnt think there is a way to do it , but you as an engr, you can use ur scripting so that you can mayb give it multiple options
am just thinking of ways cud do it
you cud say mayb if the name is this or this then it shud still work, get that particular name but then its now  prone to error bc what if you hv 2files that hv diff 
content (in one the name is capitalized and the other is lowercase then you are prone to introduce errors,) so thats why they just do it that way
so you a an engr, having worked with ansible you can predetermined what variables you want to use, so bc uve already predetermined if you just want to use os family, so now
you can run your setup module and check how to pass them
am sure theres a way around it but as of now we just stick at what we have


###########################################################################################################################



###3A)                                               

34.24/ 36.12                     USING IMPORT WHILE PASSING A VARIABLE  WILL FAIL/IMPORT IS USED FOR DATA THAT DOES NOT CHANGE
                                                Running the s(install_import.yaml)          
 ran the script  but failed
error
 when using import you cannot use variables ,you cannot hv data that is changing bc this variable {{ansible_os_family}}is suppose to be substituted when the playbk is running
so we use import when we are using it on static data ie does not change


##### 3B)
38.31                                      DYNAMICALLY
      
                         USING INCLUDE WHILE PASSING A VARIABLE  (install_multiple-pkgs_with_include_tasks.yaml)
script ran succsessfully 

so we see how include can be used 
so coming frm NO.1, performing all that task but we hv automated the process and our playbk is now as seen in no3 above 
apart frm us writing reueasable tasks, these tasks i can write another playbk and still use them 
so this is a comcept like these are like your modules, they are reuseable task bt u are just calling them , including them in your playbk
and hw am including them , am doing it dynamically


so as an engr when you anticipate that these are the tasks that you are goin to do and these are the instances that u are goin to be wrking with, u can try and do it such
that you use building variables to dynamically reduce your playbk bc u are using variables that exist, you are using your setup module to be able to call these variables

41:30
******* if i was to disable the setup(gather facts) and say false then the playbk will fail bc these variables  {{ansible_os_family}}wil nt be defined 
bc ansible doesnt knw what  this is {{ansible_os_family}}, unless i hv defined it as a  variable  ie vars:, but bc am depending on the setup module to get the buildin 
variables so i hv to mk sure that my setup module is enabled, its set to true


##########  so we hv seen what import and includes does and the differneces
and we will see now that u can create multiple/diff tasks and just put them as a library and just call those particular tasks as you need  in your playbk taking into 
consideration when its static or dynamic



43:47  
*******************
so we hv seen that we can create reuseable tasks but ansible actually gives us a better way to reuse our tasks and these are called roles 


#####  4)
                  ANSIBLE ROLES

Roles let you automatically load related vars,files,tasks, handlers, and other known Ansible artifacts based on a known file structure.

After you group your content in roles, you can easily reuse them and share them with other users. How to create an Ansible Role

You can create an ansible role by running the command below.

$ ansible-galaxy init httpd --offline               ********* httpd is the name of the role
We need to pass the --offline option so that ansible does now initialize the role from the ansible registry.

45.43          if i go to google & type ansible galaxy, there are roles that hv alreday been created, the roles are online
*********    eg if i want to  create a role for prometheus and i just run the command without offline, its goin to download or intialize a role that is online 
so if i want to create a custom role i need to pass _offline 

This is done when we want to create a custom role.

After you initialize the role, cd into the various directories and vi into the main.yml file to enter the content.


###### 5)

                   ROLE DIRECTORY STRUCTURE    
***** when a role is created, it gives you a directory structure, which will hv all these 8 directories & each dir must hv a main.yml file 

 
An Ansible role has a defined directory structure with eight main standard directories.

You must include at least one of these directories in each role. You can omit any directories the role does not use.

By default Ansible will look in each directory within a role for a main.yml file for relevant content

tasks/main.yml - the main list of tasks that the role executes.

handlers/main.yml - handlers, which may be used within or outside this role.

library/my_module.py - modules, which may be used within this role (see Embedding modules and plugins in roles for more information).

defaults/main.yml - default variables for the role. These variables have the lowest priority of any variables available, and can be easily overridden by any other variable, including inventory variables.

vars/main.yml - other variables for the role (see Using Variables for more information).

files/main.yml - files that the role deploys.

templates/main.yml - templates that the role deploys.

meta/main.yml - metadata for the role, including role dependencies.

1:22:31
********* we hv seen these examples below while creating a ROLE 
You can also add other YAML files in some directories. For example, you can place platform-specific tasks in separate files and refer to them in the tasks/main.yml file:
# roles/example/tasks/main.yml
- name: Install the correct web server for RHEL
  import_tasks: redhat.yml
  when: ansible_facts['os_family']|lower == 'redhat'

- name: Install the correct web server for Debian
  import_tasks: debian.yml
  when: ansible_facts['os_family']|lower == 'debian'

# roles/example/tasks/redhat.yml
- name: Install web server
  ansible.builtin.yum:
  name: "httpd"
  state: present

# roles/example/tasks/debian.yml
- name: Install web server
  ansible.builtin.apt:
  name: "apache2"
  state: present
By default, Ansible looks for roles in two locations:

In a directory called roles/, relative to the playbook file in /etc/ansible/roles


                             
#######  5i)
                    example of role directory
49.54   
                                                       EXAMPLE 1

                                         CREATNG A ROLE FOR A PLAYBOOK /CONVERTING THE PLAYBOOK (httpd) TO A ROLE

he cd into our ansible roles 
cd  07-Ansible\ roles/     , now he wants to create a role for httpd
07-Ansible\ roles/  ansible-galaxy init httpd --offline                                          **** httpd is the name of the role am initializing
  role httpd was successfully created      ***** and looking up, a dir httpd has been created inside of my Ansible roles 
and when i open the httpd dir, i see the 8 directories already created as we initialize this role

i can also view it, 
sudo apt install tree -y
after installation
ill run tree httpd
now i see what the directory structure of my httpd looks like 

######### 5ii)                                CONFIGURING THE ROLE

52.24
************  now we nid to configure this role 
for eg
he  went bk to his playbk and  copied the httpd.yml playbk and pasted it in the Ansible roles dir (pasting it created the playbk file automatically there )
  but now he added notifiers and handlers 

    - name: httpd
   hosts: web
   become: yes
   tasks:
   - name: Install httpd
     yum:
       name: httpd
       state: present
     notify:
       -  Start httpd
   handlers:
   - name: Start httpd
     service:
       name: httpd
       state: started


******* now ill copy the task aspect n in the httpd dir ill paste in tasks(main.yml)file
ensure its well indented
if i had up to 3 task, ill put all 3 in here too                                         ****** 57.34
also for the handlers part , ill copy it and paste in in the handlers (main.yml) file
now i hv my task n handler set 
so hv created my role for httpd and i now create my (role)playbook


                                    


59.14          ###5iii)                              MY NEW (ROLE)PLAYBOOK (Httpd.yml)
******** 
 for this remaining part, (which is my playbk) ill change tasks to roles and remove(name)  and add just httpd bc thats the role i created
  
- name: install httpd using roles
   hosts: web
   become: yes
   roles:
   - httpd                              ******** the role we created when we initialized
    

so i can go to my playbook, httpd,yml
********** now i can run my playbook
bt this playbk is using a role, its calling a role, this role  has 1task and a handler 

/07-Ansible roles$ ansible-playbook httpd.yml
PLAY   [install httpd using roles]
TASK  (gathering facts)
ok
TASK [install httpd]                  **** its runing the task frm the role 
ok                                           **** ok  bc httpd had already been installed n thats why the handlers didnt run
RECAP  


    ****** so we see i hv cretaed this role n now its reusesable bc its nt tied to any playbk am just calling the role

                                  
                    EXAMPLE2

#####  5iv)           CREATING A USER ROLE
                    (for this role, i didnt have to paste the httpd.yml file again bc we already craeted a copy of the file when we copied and pasted the file in 5111)

1:03:48

we also see a role to create a user
he had already created the role to add a user earlier
it is goin to create a grp using a grp module   (1.11.40)

***** 
groups: 
     name: "{(user_group}}"
     state: present
bc i hv a notifer in the task, it means i have a handler
opening the handler(main), its just to restart
i also hv variables,and in the vars( main.yml) i hv the variables defined there in 
in my task i passed variables uername and user grp

1:07:26
########## 

 now bk to my role playbk, httpd.yml, i can add the role 

   - name: install httpd using roles
   hosts: web
   become: yes
   roles:
   - httpd
   - user_add                        *** this is a role that has been created, i want to create a user in my webserver
                                       so bc i hv a role created, i can just run it here n reuse it


******************* now i can run my playbook
/07-Ansible roles$ ansible-playbook httpd.yml
and we see all the task done
so it has run that particular user on my host
i can ssh

*******   1.09.00
ansible@ip-172-31-16-91 : ~ $ ssh 172.31.24.167
am logged in
ansible@ip- 172.31.24.167 :$  cat /etc/passwd
ill see auser called tom, that was added  with the home
/home/tom:/bin/bash

 **** we also created groups
ansible@ip- 172.31.24.167 :$  cat /etc/groups
we see a grp called engrs that was just created


******** so when we look at the tasks (main.yml) file , 
we created a grp and it wa spassed as a variables so we are making it easy so if hv defined/created a role, i just need to use varaibles
and am making this flexible, so bc am using variables, this task is reuseable bc i can create as many users as i want, i just need to change the variables
  it is goin to create a grp using a grp module
1:12:35   ********      am using a shell module to pass the ussr i just created into the sudoers file



**********
so i hv a user module that i can use, user_add
i have a update_repos to update repositories
i hv a role to create tomcat
apart from the task, 
i have a templates bc ill be passisng dynamic data, i wnat to add tomcat users, i wnat to pass the tomcat roles and PW 
SO HV copied this tomcat user.xml file and am using it as a template  and hv passed variables inside the file that will be read dynamiaclly 
thats why am using a template, template module will read dynamic data
so in the tomcat-users.xml.j2, hv passed PW,am passing 2roles, so  based on the roles that i pass here as my variables it is goin to dynamically do this
how am i passing these varaibles?
you look at your vars dir (main.yml), in there i hv all my variables for tomcat , tomcat user , PW , role , the url where am donloading my tomcat, the version, also changing 
the  tomcat port  and am changing that port in the server.xml and bc its a ginger template , i ends with .j2 
these are template files, all templates file  we use what is called ginger templating 
is a file that that accepts variables, its a dynamic file , a ginger2 file
1:17:12
********** in the server.xml.j2, in the connector port segment, hv passed tomcat port as a variable inside the caliibrase
it is a varaiable bc it is goin to be read at runtime 
where is it been read?? .... tomcat port, inside of my variables
i just need to cm to my variables file and change, if i want my port  to be 8000 then thats the port that tomcat will run on 
if i want to change the tomcat user name , ill change it here
so all these things will now be dynamically passed to tomcat

in the context.xml.j2
we hv the esction that has been commeted out so that we hv access to the manger, so we can log into our tomcat
 so these 3 templates are been passed when you look at the task
we hv a template for authenticating with the manger
tmeplate for configuring tomcat user credentials and roles
template for replacing default port with required port
and after we hv cahnged all these, we will notify our handler to start tomcat


                         SUMMARY OF HOW TO CREATE ROLES 
1:20.00
**** it might seem as a lot of info , like its going over your head but just start by creating a simple role
create the role, intialize it , break down your playbk,didvide the task and wherever u created ur role, once u initialize it,go ot ur role, openn the dir, then just copy all
the task in ur playbk put them under the task dir, oprn d task dir and ull see a main.yml,open it & just paste ur task, those are the task for the role, if u hv any variables
that u hv passed go to the vars dir, vi into the dir (if ur doin it on the command line) cd into the vars dir and vi into main then paste ur variables 
if u hv any files, static files that you wnat to copy, i wnat to trasnfer a file frm my host to my remote server, it is a static file, ie it doesnt hv any variable so it wont
change, go to the files dir ,paste that file in the files dir, this will hold static files/content if i have a copy module.
if i hv files that are dynamic, ie files that wil change during execution then put them inside of the template, cos template support dynamic values
thats how you can easily create a role


### 6)
                                                3WAYS TO USE ROLES
1:24:00
******* 
You can use roles in three ways:

At the play level with the roles option: This is the classic way of using roles in a play.

At the tasks level with include_role: You can reuse roles dynamically anywhere in the tasks section of a play using include_role.

At the tasks level with import_role: You can reuse roles statically anywhere in the tasks section of a play using import_role


1)  example 
 what we did in    5iii)     MY NEW ROLES PLAYBOOK  (Httpd.yml)
  - name: install httpd using roles
   hosts: web
   become: yes
   roles:                                ****** this is at the play level, just using roles , its the traditional way
   - httpd
   - user_add

2) OR AT TASK LEVEL, with include roles

  - name: install httpd using roles
   hosts: web
   become: yes
   tasks:                               ******* so am passing it at a task level but am including a role 
   - include_role: httpd
   _ user_add

3) or i can import roles ,, so i can say either include or import,
but remember, we saw the limitation of when we import (if am using import,the data shud be static, but if dynamic ill use include)

  5v)                                
 #########                                           EXAMPLE 3

                              CREATING A ROLE (that has a template) 
1:33:17          making an example using the Template module (httpd.yml), in our github
                       CREATING A ROLE USING  the template module httpd playbook
******  
---
 - hosts: web
   become: yes
   tasks:
  #Tasks:
   - name: Install httpd
     yum:
       name: httpd
       state: present
 #Tasks
   -template:
  src: index.html.j2
  dest: /usr/share/httpd/no index/index.html
notify:

he created the httpd1.yml file then copied and pasted the template module , so the httpd1.yml is now our role playbook
in the role playbook he added a handler bc he added a notifier
then he initialized the httpd1 role
now having gotten the role structure,
**********the task module goes into the task (main.yml) dir, handlers goes to handler(main.yml) but the file: index.html.j2, needs to exist inside the template dir
inside the template ill create a file 
i can call  the file: index.html.j2  bt its a jinger2 template bc it has dynamic data

inside it i can put content like:                                       ****** i bliv insid ethe index.html, ansible hostname is a defined variable
welcome to landmark Ansible Automation from, then i can pass a varible {ansible_hostname}         ****** this wil return the ip address of the insatnce, an ansible hostname
bc when you check among the default defined variables there is an ansible hostname which gives you the ipaddress of the particular instance 
so now hv created this index.html file that is inside of my template 
so bk to my role playbk (ie the new role playbk), i can remove the task and the template, i dnt need all this 
i can use a role 

           httpd1.yaml
   -name: install httpd with dynamic role
   - hosts: web
   become: yes
   roles:
   -httpd1                       *** the role we created when we initialized

/07-Ansible roles$ ansible-playbook httpd1.yml
PLAY [installhttpd with dynamic role]
TASK[gathering facts]
ok  [172.31.24.167]
TASK [httpd : install httpd]
ok [172.31.24.167]
TASK [httpd1: template]                       ****   it has now transferred the template file
ok [172.31.24.167]
PLAY RECAP
 
1:48:56
now this is the ip address, let me find the public ip 
then he went to the terfrm terminal (local env) that has the output , copied the public ip 
  ******* now goin to google, if i paste that public ip address (34.216.78.183:80) we ll see:

welcome to landmark Ansible Automation from, {172.31.24.167}       ***** This is your ansible hostname 

SUMMARY:
inside my template (index.html.j2), i passed it as a variable, so the variable "ansible hostname" was dynamically pulled bc i put the html, we hv a default index html that
runs but i replaced it,i substituted, i removed the default one and now i put my custom index.html, and that custom i passed it as a template but i had a variable , so this
variable was dynamically passed, if i had to put another variable    ...1:49:58
i can modify the template and put another variable : lets use a variable we are familiar with
welcome to landmark Ansible Automation from, then i can pass a varible {ansible_hostname} and {ansible_os_ansible_family)
so this is an inbuilt variable, a building variable,so the expectation is ansible os family is suppose to return a redhat , so am dynamically passing it as a template so
the value will be substituted at runtime when the setup module run
now if i go into my template, ill see it has returned a Redhat:
*********** welcome to landmark Ansible Automation from, then i can pass a varible {ansible_hostname} and RedHat
so am uisng a template to automate this process
but if this was static data, if i use a file module then this will not work, bc this variables have to be dynamically read and thats why we use a template module ,
in our task we use a template and we need to have our src, our html, bc template is the same as copy,
if we use copy we ll hv a source and dest

Tasks
   -template:
  src: index.html.j2                   ******** if we use copy, this needs to be static data 
  dest: /usr/share/httpd/no index/index.html

but bc its dynamic thats why we are using a template module, its goin to tk that file &transfer it into user, share, httpd ,no index and its goin to replace that index.html
before  and that will be the destination and the values will be dynamically replaced

                                 
                                                    QUESTION


**** 1:56:40     

1) frm the last eg 5v) above, u did src and dest and i know when u were teaching us b4 abt copying and all that thers a place "  remote source =yes
does it apply in this case, if not wher is it applicable??

i think he was refrering to the Tomcat playbook in video3, (3:00:1)

  unarchive:                                                                
          src: "/usr/local/apache-tomcat-{{req_tomcat_ver}}.tar.gz"          
          dest: /usr/local                                                       
          remote_src: yes    

ANS:

its not bc our index.html file is right here, its on our control node, we are like copying frm where we are , our conrol node &its goin to a remote, so thats why we are not 
doing a remote src but if this index.html (src: index.html) was inside of this server,i think (web host), then we could say the src, we will give it the path to where it is 
then the dest, then we ll put "remote src = yes" bc all this action is happening in this server (web host) bt in our case we created our index.html in our local host(i bliv 
control node) which is running our ansible 


     ###### after break we go to dynamic inventory

1:58:55
2) is there an automating tool to format the yaml file just the way we hv with tefrm format instaed of this manual setting  and evrtime trying to set the yaml for the syntax

ANS:

i wouldnt say there is but on the vscode, i think you shud hv , you can install the extension (look video ,1:59:12) on your vscode
i think you can instal a yaml extensin that helps with fromatting or syntax
but am nt sure ther is one as we run terfrm format to automatically format, thats why its imp you understand/knw how to write yaml
i dnt think ders a short cut out of that, but yaml it is veryeasy u just need to pay attention to indentation
but otherwise wverything is just writing it as a map or a list , with just identation and you can always just use a tab or auto spaces for indentation



3) whats the sequence for execution when it comes to the roles file
Also, i was wondering lets say its an xml file, will like just get the original xml file and mk certain tins variable and just put a .j2 and that will be enough to create a 
a your templat file??

ANS:  2:02:21

any template file will be a jinger2. bc we are using templating, so u can get any template file bt we knw when u hv like an http or apache server, we hv what is called an 
index.html page, that is the index.html that always deplays on the site once you logon , that is your default page, so as long as that file is called index.htm then yes
that is the file that we are using, so u can get any file but as long as its called that name and it has that extension then u can pass in your variables, if this file
  src: index.html.j2  (index.html.j2) was static then ill just pass it as index.html, now here i can either use template or copy, it doesnt matter cos template can transfer 
both static or dynamic, it doesnt matter but if i want to pass a dynmaic i must use template, if i use copy, i can only pass static, if i was using copy then this file will
just be index.html, i dnt need to put .j2, bc .j2 is making it a template file 

******* then for sequence, it will follow the task, everything always executes the tasks, the actual work that is been done is base on the task, evrything is written as a 
task so it will follow the sequence of the task... 
if a task calls a handler then it is executing that task 
so the order it is procedural but it always follows your task if u just hv one task then that is the task that is goin to run 
if i hv multiples roles, like if i hv 2roles that am calling then it will be ordered in the sequence of hw i hv placed, it will be role1, then role2 
but in role1, it will always be task1, task2, task3 till the end , then when that is done it goes to role2 and repeats the same process
but if i hv those 2 roles but smt in role1 fails then the playbk will fail bc ansible is procedural


#####7)

  *******  2:06:00                                       DYNAMIC INVENTORY 


    what we'v been configuring, when we configure our host list inside of our hostfile (in etc/ansible)and change our inventory (ie when he added the ip addresses of our 
host servers) so bc our inventory ha sbeen changed, this is static so in our hostfile here, we hv been using static inventory bc this (ip address, below he said we hv to 
configure it for it to change)
does nt change bt you could hv what we call dynamic inventory.
ansible comes with various dynamic inventory pluggin , one of which is aws ec2, so with the pluggin installed then we can mg8 our inventory instead of us having a static 
iventory, we can manage it dynamically.

   Ansible comes with various dynamic inventory plugins one of those being aws_ec2.

The aws_ec2 plugin is a great way to manage AWS EC2 Linux instances without having to maintain a standard local inventory.

This will allow for easier Linux automation, configuration management, and infrastructure as code of AWS EC2 instances.

***********  In order to use the aws_ec2 plugin, the following requirements have to be met;

When naming the plugin, the suffix portion of the name must be: _aws_ec2.yml or _aws_ec2.yaml
For example:

  production_useast_aws_ec2.yml                                               **********if am naming a plugin for my prod env bt it has to end with  _aws_ec2.yaml
  production_uswest_aws_ec2.yml
  test_dev_aws_ec2.yml
  production_aws_ec2.yml

Each individual configuration file from above could have its own aws_access_key and aws_secret_key pointing to individual AWS accounts that separate production, test/dev, 
etc. All of these individual configuration files can be placed within the ./ansible_plugin directory.

2:10:40
***************Eg(  production_useast_aws_ec2.yml, this could be in a diff account or diff region, i could be configuring my prod env in us east, my test env in US West, or 
it could be in diff aws account, so i can configure this pluggins, this names that am passing they are just meta data, just for me to knw what pluggin am using, once hv 
configured the pluggin, i can put them either in the ansible plugging dir)
              
           ***** (he said ansible.cfg file)
If you have the ansible.cfg with inventory = ./ansible_plugins you will be able to view AWS EC2 inventory based on the aws_ec2 plugin configuration file with the following
command:         ill xplain what that means .....

 $ ansible-inventory --list --yaml


####7i)

STATIC AND DYNAMIC INVENTORY:

A static inventory file is a plain text file containing a list of managed hosts (just like the hostfile list we configured) or remote nodes whose numbers and IP addresses 
remain fairly constant.
On the other hand, a dynamic host file keeps changing as you add new hosts or decommission old ones.
******eg(if i go into aws and create more ec2 instance, my static file will nt change bc i hv to configure it, but if i had a dynamic inventory and i created 5more instances then
my inventory will change bc the pluggin will find and additioanl instances)
 The IP addresses of hosts are also dynamic as you stop and start new host systems. (so bc of that, that is dynamic,so you wnat an inventory that when the system changes
it will also chnage so that it gets the right ip)


   ######7ii)
                                        THERE ARE 2WAYS FOR YOU TO DO IT

Ansible Dynamic Inventory for AWS:

1) Script

Search for the ec2.py script.                    ***** we hv a python script , but to use it u need to install  boto/boto3 -SDK

Install boto /boto3 -SDK

You can use this script in one of two ways.

a) Ansibleâ€™s -i command-line option and specify the path to the script after marking it executable
 $ ansible -i ec2.py -u ubuntu us-east-a -m ping

b) The second option is to copy the script to /etc/ansible/hosts and chmod +x it. You must also copy the ec2.ini file to /etc/ansible/ec2.ini. Then you can run ansible as
you would normally. (ie, instead of the host file list we configure, we copy this and paste it in there, so the script now becomes you hostfile then mk sure the script is
executable chmod +x then copy the ec2.ini file to /etc/ansible/ec2.ini dir , then run ansible as normal)

To make a successful API call to AWS, you must configure Boto (the Python interface to AWS). You can do this in several ways available, but the simplest is by exporting two
environment variables like follows.

export AWS_ACCESS_KEY_ID='AK123'                                        2:15:24
export AWS_SECRET_ACCESS_KEY='abc123'                       ******* or u can attach a role to ur ec2 instance
After downloading the 2 scripts and configuring boto/boto3, in your terminal simply type ec2.py --list

Note*: Dynamic inventory brings all the instances across all the regions in your AWS account, so no need to specify the region
 this is one way that you can do it to get your dynamic inventory but ill leave this for your guys to try it out
if u want that particular script, just go online and type ec2.py script , in the github copy all the script then , this is 1700 lines of code
https://github.com/vshn/ansible-dynamic-inventory-ec2/blob/master/ec2.py
so thats a phyton script that you can use to be able to getthat dynamic inventory
but when you follow those instructions, ull also need the script called ec2.ini file, and follow the instruction to see hw u can get that particular dynamic inventory
https://github.com/willthames/ansible-ec2-example/blob/master/ec2.ini
ill send the script to the chat



******2:18:11
but am goin to show you a easier way and this is the preferred way by using a pluggin 
https://docs.ansible.com/ansible/latest/inventory_guide/intro_dynamic_inventory.html               ********* 2:20:50
if you go to ansible dynamic inventory,
it wil show you the diff type of inventory script
https://docs.ansible.com/ansible/latest/plugins/inventory.html
it shows you like what to do 
you can create an inventory , using an inventory pluggin


what you need to do , is first the plugging needs to be aws pluggin, 
*** 2:24:38
thers an aws ec2 pluggin
https://docs.ansible.com/ansible/latest/collections/amazon/aws/docsite/aws_ec2_guide.html
so we are goin to use this method (in the link)which is much easier

so first u need to instal the plugging frm what is called ansible galaxy
u need to install amazon. aws pluggin
but we are goin first to install boto3 on our env 


####  7iii)

2) aws_ec2 plugin:                          ** 26:00

Requirements
Install python3-boto3
sudo apt-get update -y
sudo apt-get install -y python3-boto3
Install plugin
   $ ansible-galaxy collection install amazon.aws
Create an inventory file which must end with - aws_ec2.yml/yaml     ****** he already had his inventory file (aws_ec2.yaml), inside he stated his plugin is aws_ec2
                                                                  
Attach a role on your server to make api calls to aws

Configure ansible.cfg file to read inventory from the plugin

test the configuration

 $ ansible-inventory --list
Example of aws_ec2 plugin

# Run the command <$ansible-galaxy collection install amazon.aws> to install the plugin
# Create the inventory file that ends with <aws_ec2.yml/yaml> and use the examples in the ansible documentation to configure it.
# Configure the ansible.cfg file to read the inventory from the aws_ec2.yaml file


###7iv)

            EXAMPLE OF INVENTORY PLUGGIN  (aws_ec2.yaml)

plugin: aws_ec2
regions:                                am configuring this plugin in us west2 he want sto find his inventory in us west2 but u can choose a region
 - us-west-2                              he also define dthe grps (u can see hw to do it in d documentatio)hw u can create ur inventory file
keyed_groups:
  - key: hostname                           *** for the host name i want to get the ip address
    prefix: ip-address
  - key: placement.region
    prefix: aws_region
  - key: tags.Type                               ******* i want to get the tags, a type vs a name 
    separator: ''
  - key: tags.Name                                 so i want to filter and get my instance based on all this things 
    separator: ''
hostnames:                                    **** and for the host name i want to get with of these 
  - ip-address
  - dns-name
  - tag:Type
  - tag:Name
  - private-ip-address
In the ansible.cfg file set the defaults to:

inventory = ./aws_ec2.yaml
host_key_checking = False



##   so once i hv this created 

**** then above it says:  
Attach a role on your server to make api calls to aws
Configure ansible.cfg file to read inventory from the plugin
************************** so  now the yaml file (aws_ec2.yaml) becomes my invnetory pluggin 

7v)
###########                  CONFIGURING ANSIBLE.cfg
   
 
2:29:00              WATCH

he copied the file from his dynmic inventory dir to the ansible mc series home
now let me configure my custom configuration file
he ran 
cat /etc/ansible/ansible.cfg
to see the command to  customise the configuration file  (ansible-config init --disabled -t all > ansible.cfg
ansible@ip-172-31-16-91:~/Ansible-mc-series$ ansible-config init --disabled -t all > ansible.cfg
now it created for us a ansible config file  .. ansible.cfg
he opens it and scrolls to the inventory section  and changed 
inventory=/etc/ansible/hosts  to inventory=./aws_ec2.yaml
so am setting my inventory bc my config file is in this pwd but its a file called: aws_ec2.yaml
once i pass this, this is now what is called custom inventory and its a custom config file
bc we say the order for which ansible looks for either an env variable if it doesnt see that it wil look in the pwd 
so if i hv a config file in the pwd then this will tk precedent , it wil be reading frm this file and it will not be reading frm the etc/ansible dir 
bc thats the deafult so that wil be the last option
so b c a hv a config file in the pwd so this is a custom inventory but in that inventory i need to mk sure am pointing my inventory to this aws ec2 plugging (aws_ec2.yaml)
so hv set our plugging and obviously we hv host key checking set to false
still inside the custom inventory/config file, we scroll to hostkey checking 
we can either check for it or in the same inventory section we add
host_key_checking = false
so hv configured my ansible config file 
so when i run 
ansible@ip-172-31-16-91:~/Ansible-mc-series$ ansible all -m ping
unbale to locate credentials, so its trying to use the credentials but its unable to locate credentials so bc of that you can setup a role
you can attach a role to your server, a role that will mk api calls to your servers
now in aws , he wants to attach a role to the ansible server
he needs to give the instance permission 
so click actions, security then modify role.
i currently hv an anasible terfrm role so i can attach that and update , or i can create a role an just give it permission 

*********** 2:40:45 those permission needs to hv ec2 but that role has adminitrator permission so create a role 
and it has been 
i hv a mac so i can run ansible on my local env 
so if am runing it locally, it will just use my proflie , it will us ethe credentials that hv configured when i did aws configure so those are the credentials that it wil use
once it uses those credentials ,its able to query using boto3, its able to mk api calls 
so hv attached my role to my ansible server
ansible@ip-172-31-16-91:~/Ansible-mc-series$ ansible all -m ping
still error
decided to create an admin role
2:42:42******* now in aws IAM  but he cant update a role
***** 2:48:40   ... decided to create keys, which is nt the recommended way
needs to run aws configure bt first aws cli
for security this is nt the secured way bc this an instance that wil hv multiple people accessing it so you cant pass static credentials like that, thas why we always attach 
roles, but i dnt knw why its not working
ansible@ip-172-31-16-91:~/Ansible-mc-series$ ansible all -m ping
success
so it has found 3servers n its been able to connect to them but also, it has found 2others in my inventory,, 2others that are nt part of the inventory but that pluggin went 
and found 
if i check aws, ill see 5instances that are running 
bt these 3instances are the once that i has already exchanged the keys thats why ansible is able to make an ssh connection to them 
for the other 2, unreachable, the key have nt been exchanged
but your dynamic inventory is finding the instances
lets say i launch 2other instance 
let me see if i can use ansible to find them#
ansible@ip-172-31-16-91:~/Ansible-mc-series$ ansible all -m ping
ansible finds them, so its able to dynamically find these instances 
lets stop one instance in aws so that its ip changes 
restarts it, now it has another ip  .... lets run ansible and see hw it handles it 
ansible@ip-172-31-16-91:~/Ansible-mc-series$ ansible all -m ping
so now it finds it too
so now i see it doesnt matter the state of my instances 
ansible bc of the plugging will go and get me dynmic inventory based on what is happening here, so i dnt hv to create a host file 
so am jsut craeting as long as i can run terfrm to create my instances then i just run ansible with dynamic inventory then that inventory,it will just go to aws whatever 
region its goin to find that inventory, even ifi hv 60instances, it will find the instances and ansible will be able to connect to them

  *****  for us to be able to achieve this 
what comapnies do in production, so thats why they will use custom amis
it just mean that u are goin to firts create an instance and bc this instance you hv already exchanged the key so ull create an ami fmr this instance 
then you will spin up all other instances in your env using that custom ami
now with that once you run ansible, ansible will just mk connection to all of them bc already the key has been exchanged so ull just hv ssh connection by default
so thats what companies in prod do , so ull always use a custom ami

########### so for yoy guys what ill like you to do for your project is 
use this inventory but create a custom AMi
what i mean is go tru the process to mk passwordless authentication just with one server
now once you hv that one server that ansible is able to connect to, u hv used a custom iventory then u are goin to copy that AMi or rather you are goin to create an ami 
frm that instance

e.g 
using my ubuntu1, i hv already exchanged the key 
i will create an ami frm it, u hv to create an image, u hv to stop it then create an image fmr this particular instance
then the image will be available as one that you own, then copy that ami id and now cm to your terrfrm code (ec2.tf)
***********  3:04:10 bc now you are using a custom ami , inside the  tfrrm code, in place of your (resource for ubuntu) ami pass the ami id,  and also for your host
you can pass it as a variable
it jst means that all your host will already hv the key configured
so u will always be using a custom ami and now with that u are able to run your dynmica inventory and it will always succeed bc ur key has already been exchanged
so this is how we use dynamic inventory to manage our servers


  ******* and in production u wil hv to be using  the method of dynamic inventory bc if ur working in an env that has a 100 0r 200 servers
you are suppose to configure 200 instances to patch them , u will not be able to create a static host file bt instaed ull neeed to know how to use dynamic inventory and for
that as we ve seen you are able to use a plugging



      QUESTION

1) i was wondering hw u wud hv used the iam role to acces the instance since we didnt do that , dnt knw if its in our notes

ANS:
 an i am role, we normally acttach a role to an instance , u can create a role and attach your instance bc your instance it needs credentials  bc we are quering an API in 
aws, aws api, so bc of that we need to configure a role, we need credentials but i dnt knw why my role wasnt working in aws


3:09:14

when you create a role it creates what is called an instance profile, it gives ur instance a certain profile with permission, so am giving it permission to access other
aws services bc by default services hv , bc of IAM, all services hv deny policy, they are denied to access any other services unless you explicitly allow them 
so thats why now for ec2, bc am running my workload frm an ecs instance so this ec2 instance (my ansible control node) it needs permission bc its accsesing other instances 
to find their meta data so bc of that it needs permission and that permisson u can create a role but as we saw the role wasnt working thats why i created a secret and access
key but that is a security issue, we are nt suppose to store accsess key and secret key inside of your instance soinstaed u always use a role bc role are short lived 
they are nt like permanent, bc they hv sessions, i think a section by default will last for an hour then that session will be over 

3;14;00
but if i was running that on my local env(terrfrm) and bc am running it on mac which is linux, therfpre am able to run ansible, am able to install ansible on mac bc its a 
linux env 
i run ansible , i see i hv ansible installed

3:19:00  ;;....   bla bla bla 
he passed a custom AMi


3:24:20

once you guys hv created custom AMI for your creation of your instances 
ll hv this script 
so the fist thing 
u hv cd into trfm script and go to script
the ls
ull see some terfrm files  together iwth the playbks
whhile you are in there then just run tefrm  init its goin to intilaize ur backend , then terffm plan
it wil create 16 resources 
then run ansible playbk  nmae: site1.yaml
so bc ur inventory is reading frm the pluggin , once you write that its goin to mport those particular palybks
bt obviuosly i need ot do some wrk on my roles 
so run terfrm to provion your resources then run ansible 
the prequitse is you need to hv created your ami that u hv exchanged the keys with
bc that is the only way ansible is goin to pick your  all your inatsnces put them in adynamic inventory an drun this playbk againt them
so just by basic commands you are goin to provision your entire infrastructure , they will all be provisioned
your ka8 will be reday to go , ut tomcat, sonarqube will be ready to go 
so your entire pipeline as we hv done it in class 
this is a project that i did it too me a couple of mayb a monh or so just to mk sure that everything works 
but its able now to provison your entire infrastructure just using terfrm and ansible 



3:28:24
  QUESTION

DID We at any stage exchange key with my other instance(d once we created directly on aws) that we created bc hw is ansible master absle to ping my other instance since it
wasnt created frm terfrm 

ANS:
the way inventory works is its not necessary that it needs to be created with tefrm, it just goes in your aws, whatever inatsnce it finds there it get sit ip adress
so whather u created it with tefrm or nt it will just go to a region and find all instances and return them 
but if you wnat to select specific ones that swhy ull now use tags 
if i want to confihure only instances with a specific tag then i can pass that in my playbk, i can say this playbk will run on instances with a tag called tomcat so thats
how dynamic inventory will wrk , its now goin to use tag to filter to deter which instances to use 
so thats why whenevr u are provisioning instances you hv to tag them give them a name in prod that show it works
if its a server that belongs to prod , it has to be tagged ad prod  etc, cos when ansible goes to do configuration it is looking for those particular tag for it to be able 
to configur

2) in prod do we actiually shut doen servers??
ANS:
NO , it depends , if its in prod thats a downtime , ur instances dont, but if its goin for maintenance
but then in prod we use elasic ips bc u asign an elastic ip on your instance so that even if your instance stops or it goes down,it will stil maintain the same ip bc of dns
we always want your ip not to change so must of ur instances in prod will hv elastic ips 


3) i was aksed this question in an interview and i was really kind of confused 
in production if for example the manger approves a line of code, how does the process go ???  frm the tesing to prod and now the manager has approved that the code is fine
how do we proceed frm ther

ANS:

if its approved , if its anything that has to do with code then that particular code is merged depending on whatever line 
if ur working on dev branch or staging branch or a bug fix that always needs somebody to look at or if its a new feature that you are developing then once the code has been 
written and ther has a peer review, it has been reviewed , and the pipelines have run and they hv succeeded and they hv run all the test and it has been approved
once it has beeen approved then you can click the button to merge bc your pull request has been approved now now you can click the button to merge and your now merging it 
into main or your merginging it into whatever branch that ur suppose to be merging into once that is merged then basically the pipeline wil tk over and run & create a build 
frm there
but its always that once you do your work your peers or manager has to approve nad thats why you will craete a pull req, ie ur asking for other to review your wrk before its 
merged bc u cannot approve your own work, someone else has to and for that to ahppen they hv to look at what uv done 



the main is what is in prod so ur creating a branch out of your mainand if its just a hot fix,u do ur modification/changes and do your pull reQ wnwich i stour requeting for 
your hotfix to be merged back into main cos your just modifying, it was a bug or smt so you create a pull REq , ur peer or peers will look at it if its approved , you obviusly 
once you create an hotfix branch as you creater apull REq A PIPELINE WILL RUN TO ENUSRE THAT DOES WHTAT SSUPPOSE TO DO , once it passes and its approved then u can merge 
directly into the main and that resolve the isue that wa running in production



 that brings us to the end of what need to knw about ansible
but ill send you a video on ansible vault , abt 10minutes 
abt ansible vault its just commands in which you run
ill send you a short video on hw to use ansible vault
we jsut use ansible vault in terms of encrypting our  playbks or encrypintg our PW, sorry
Its just smt that we need to knw abt how do we encrypt our playbk, w evan use ansible vault to do that
but otherwise all that u hv abt playbk adhoc commands , and how to configure your env that is is the foundation of what you need to knw abt ansible
but once you go tru the bootcamp, hopefull now ill hv more info but also ull hv more time to play around with playbooks and just undestand
once u understand how playbks aworks and how roles wrks that the whole of ansible that you need to know 
cos ansible is bat playbooks and roles 
you just need to know hw to write them, how to configure them esp using import, when to import
bc in ansible ull be uaisng a lot of variables 
so mastaer hw to use template , using roles and passing them in diff env
and obviously u will encounter a lot of other ansible module sthat we hvant evne looked out 
but again the prequisite whne u go to an interview they will ask you what ansible module hv you used 
we hv the basic modules, what are the ansible default modules
again we knw the default modules ie the comand and setup
what does the setup module do, how do you disable it 
what are the limitation of the ocmmand module
so those are the basic things that we need to understand about ansible










   ill send the vault video

































